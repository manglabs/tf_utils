#!/usr/bin/env python

#####################
#
# Migrate leads / potentials from Zoho crm into Customer.io
#
#
# TODO Require name be filled in in CRM so we can personalize email.
# TODO "signed up at" should be a date / time so we don't lose granularity we had at lead sign up time.
# TODO create way for any contact to be allowed to receive newsletter (investors, long term hires, who else?)
# TODO there's no "resubscribe:" anyone who resubscribes will be auto-unsubscribed when mismatched_unsubscribed() is run
#      The only way to do this is to have Zoho be the canonical data source: replace the unsubscribe URL w/ an API call to Zoho.
#
#####################

import os, pdb
from datetime import datetime
from optparse import OptionParser

from mfabrik.zoho.crm import CRM
from beautiful_soupcon_tf_zoho import (ThinkfulPerson, 
    get_zoho_contacts, _stitch_pages)
from tf_utils import get_cio, get_crm

def get_all_potential_contacts(crm, all_contacts):
    tf_people = []
    if crm.use_api_allowance:
        serial = open('potential2contact.csv', 'w')
        serial.write('email,contactid,potentialid\n')
        # pdb.set_trace()# beware api quotas
        for potential in _stitch_pages(crm.get_potentials):
            for contact in crm.get_contacts_for_potential(potential['POTENTIALID']):
                ptfp = ThinkfulPerson.from_zoho_potential(contact)
                serial.write('%s,%s,%s\n' % (ptfp.email, ptfp.zoho_contact_id, potential['POTENTIALID']))
                serial.flush()
                tfp = all_contacts[ptfp.zoho_contact_id]
                print "Mapping", ptfp, "to", tfp
                tfp.funnel_stage = potential['Stage']
                tfp.signup_date_from_potential = tfp._parse_date(potential['Signed up at'])
                tf_people.append(tfp)
        serial.close()
    else:
        fh = open('potential2contact.csv', 'r')
        potential2contact = {}
        for line in fh.readlines():
            email,contactid,potentialid = line.split(',')
            potential2contact[potentialid.strip()] = (email, contactid)
        fh.close()
        for potential in _stitch_pages(crm.get_potentials):
            try:
                (email, contactid) = potential2contact[potential['POTENTIALID']]
            except KeyError:
                print "PotentialID '%(pid)s' has no associated contact! Skipping. Check url https://crm.zoho.com/crm/ShowEntityInfo.do?module=Potentials&id=%(pid)s&isload=true" % (dict(pid=potential['POTENTIALID']))
                continue
            tfp = all_contacts[contactid]
            tfp.funnel_stage = potential['Stage']
            tfp.signup_date_from_potential = tfp._parse_date(potential['Signed up at'])
            tf_people.append(tfp)
    return tf_people

def _dt2unix(string_date):
    (y,m,d) = map(int, string_date.split('-'))
    dt = datetime(year=y, month=m, day=d)
    return dt.strftime('%s')

def send_potentials_to_customerio(crm, cio):
    all_contacts = get_zoho_contacts(crm)
    contacts = get_all_potential_contacts(crm, all_contacts)
    for c in contacts:
        print "Sending potential %s to customer.io" % c
        # pdb.set_trace()
        try:
            cio.identify(id=c.email, email=c.email, 
                created_at=c.signup_date.strftime('%s'),
                funnel_stage=c.funnel_stage, 
                contact_type=c.contact_type)
        except AttributeError, ae:
            print "Could not send %s to customer.io! %s" % (c, ae)

def send_leads_to_customerio(crm, cio):
    for lead in _stitch_pages(crm.get_leads):
        tfp = ThinkfulPerson.from_zoho_lead(lead)
        if tfp.funnel_stage == 'Signed up':
            print "Sending lead %s to customer.io with funnel stage '%s'" % (tfp, tfp.funnel_stage)
            cio.identify(id=tfp.email, email=tfp.email, 
                created_at=tfp.signup_date.strftime('%s'),
                funnel_stage=tfp.funnel_stage, 
                contact_type=tfp.contact_type)
        else:
            print "Not sending non-funnel lead %s to customer.io" % (tfp)

def _inc_or_1(d, k, v):
    if d.has_key(k):
        d[k].append(v)
    else:
        d[k] = [v]

def all_leads_also_contacts(crm):
    """Show all contacts or leads with overlapping email addresses"""

    leads = {}
    print "Getting all leads..."
    for lead in _stitch_pages(crm.get_leads):
        leads[lead['LEADID']] = lead['Email']
    
    contacts = get_zoho_contacts(crm)

    dup_emails = {}
    for contact in contacts.values():
        _inc_or_1(dup_emails, contact.email, contact.zoho_contact_id)
    for lead_id, email in leads.items():
        _inc_or_1(dup_emails, email, lead_id)

    if len(dup_emails):
        print "Found %s leads that are also contacts:" % len(dup_emails)
        print "Format: {email} : [zoho_id, ...]"
        for email, items in dup_emails.items():
            if len(items) > 1:
                print email, ":", items
    else:
        print "No leads found that are also contacts!"

def mismatched_signup_date_potentials_contacts(crm):
    all_contacts = get_zoho_contacts(crm)
    contacts = get_all_potential_contacts(crm, all_contacts)
    for c in contacts:
        if not c.signup_date_from_potential and not c.signup_date:
            print "No known signup_date for %s" % (c)
        elif c.signup_date_from_potential == c.signup_date:
            print "Signup date is all good for %s" % c
        elif c.signup_date_from_potential and not c.signup_date:
            print "Updating missing signup_date for %s to %s" % (c, c.signup_date_from_potential)
            contact = {
                "Id": c.zoho_contact_id,
                "Signed up at": c._dt2zoho(c.signup_date_from_potential),
            }
            contacts = crm.update_contacts([contact])
        elif not c.signup_date_from_potential and c.signup_date:
            print "Contact has signup date %s, Potential is missing for: %s" % (c.signup_date, c)
        else:
            print "Mismatched signup date %s! %s vs %s" \
                % (c, c.signup_date_from_potential, c.signup_date)

def missing_signup_date_leads(crm):
    print "Getting all leads..."
    for lead in _stitch_pages(crm.get_leads):
        tfp = ThinkfulPerson.from_zoho_lead(lead)
        if tfp.signup_date:
            print "Signup date is all good for lead %s (set to %s, created %s)" \
                % (tfp, tfp.signup_date, tfp.created_date)
        elif tfp.funnel_stage:
            print "Correcting missing signup date for lead %s (should be created date %s)" % (tfp, tfp.created_date)
            # pdb.set_trace()
            lead = {
                "Id" : tfp.zoho_lead_id,
                "Signed up at": tfp._dt2zoho(tfp.created_date),
            }
            crm.update_leads([lead])
        else:
            print "Lead doesn't / shouldn't have signup date %s" % (tfp)

def _get_zoho_unsubscribed(crm):
    print "Getting all unsubscribed leads & contacts from zoho..."
    unsubscribed = set()
    search_condition = "(Email Opt Out|=|true)"
    for lead in _stitch_pages(crm.search_leads, search_condition):
        unsubscribed.add(ThinkfulPerson.from_zoho_lead(lead))
    for contact in _stitch_pages(crm.search_contacts, search_condition):
        unsubscribed.add(ThinkfulPerson.from_zoho_contact(contact))
    print "Found %s unsubscribed leads & contacts." % len(unsubscribed)
    return unsubscribed

def _get_cio_unsubscribed(cio):
    print "Getting all unsubscribed customers from CustomerIO..."
    unsubscribed = set()
    segment_json = cio.get_segment([12366])
    # print segment_json
    # segment_json = {u'customers': [{u'attributes': {u'_delivered_email:11314547': 1366991323, u'_opened_email:10545898': 1366308241, u'id': u'ordinaryjoe80@gmail.com', u'_segment:9334:cache': 0, u'_last_emailed': 1367425173, u'_segment:8885': 1364312770, u'unsubscribed': True, u'_delivered_email:9495073': 1365003876, u'email': u'ordinaryjoe80@gmail.com', u'_segment:11802': 1367375408, u'funnel_stage': u'Expressed interest', u'_opened_email:8857892': 1364332246, u'_first_seen': 1364312770, u'_opened_email:9917495': 1365629371, u'_segment:9308': 1364875200, u'_opened_email:11314547': 1366991404, u'_delivered_email:10545898': 1366303665, u'contact_type': u'Student', u'created_at': 1364270400, u'_segment:12366': 1367932534, u'_delivered_email:8857892': 1364327346, u'_delivered_email:11635216': 1367425173, u'_opened_email:11635216': 1367426066, u'_opened_email:9495073': 1365005012, u'_delivered_email:9917495': 1365617210}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367375408, u'Unsubscribed': 1367932534, u'At least a week old': 1364875200, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': 1364312770, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': None, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'ordinaryjoe80@gmail.com'}, {u'attributes': {u'_last_emailed': 1365003876, u'_delivered_email:8857925': 1364327360, u'_segment:11802': 1367276125, u'_segment:9334:cache': 0, u'funnel_stage': u'Missed call', u'created_at': 1362546000, u'contact_type': u'Student', u'_segment:12366': 1365007169, u'email': u'rmontanodupont@outlook.com', u'_first_seen': 1364312787, u'unsubscribed': True, u'_segment:9308': 1363150800, u'_opened_email:9495086': 1365007130, u'_opened_email:8857925': 1364327538, u'id': u'rmontanodupont@outlook.com', u'_delivered_email:9495086': 1365003876}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367276125, u'Unsubscribed': 1365007169, u'At least a week old': 1363150800, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': None, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'rmontanodupont@outlook.com'}, {u'attributes': {u'_last_emailed': 1367425174, u'_segment:11802': 1367276132, u'_segment:9334:cache': 0, u'funnel_stage': u'Verbal close', u'_delivered_email:11635304': 1367425174, u'created_at': 1354770000, u'contact_type': u'Student', u'_opened_email:11635304': 1367425893, u'_segment:12366': 1367932558, u'email': u'hello@jeffreylo.cc', u'_first_seen': 1364312796, u'unsubscribed': True, u'_segment:9308': 1355374800, u'_segment:8888': 1364312798, u'id': u'hello@jeffreylo.cc'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367276132, u'Unsubscribed': 1367932558, u'At least a week old': 1355374800, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': 1364312798, u'funnel_stage - Signed up': None, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'hello@jeffreylo.cc'}, {u'attributes': {u'_last_emailed': 1367425188, u'_segment:11802': 1367276146, u'_segment:9334:cache': 0, u'funnel_stage': u'Verbal close', u'created_at': 1354770000, u'contact_type': u'Student', u'_segment:12366': 1367932541, u'email': u'mattis@makeitweb.se', u'_first_seen': 1364312810, u'_opened_email:11635406': 1367425492, u'unsubscribed': True, u'_segment:9308': 1355374800, u'_segment:8888': 1364312811, u'id': u'mattis@makeitweb.se', u'_delivered_email:11635406': 1367425188}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367276146, u'Unsubscribed': 1367932541, u'At least a week old': 1355374800, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': 1364312811, u'funnel_stage - Signed up': None, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'mattis@makeitweb.se'}, {u'attributes': {u'_last_emailed': 1367425177, u'_segment:11802': 1367276155, u'_segment:9334:cache': 0, u'funnel_stage': u'Closed Lost', u'_opened_email:11635334': 1367425211, u'created_at': 1354770000, u'contact_type': u'Student', u'_segment:12366': 1367932580, u'email': u'matthew.a.hines@gmail.com', u'_first_seen': 1364312816, u'_delivered_email:11635334': 1367425177, u'unsubscribed': True, u'_segment:9308': 1355374800, u'id': u'matthew.a.hines@gmail.com'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367276155, u'Unsubscribed': 1367932580, u'At least a week old': 1355374800, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': None, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'matthew.a.hines@gmail.com'}, {u'attributes': {u'_last_emailed': 1366303666, u'_opened_email:9917528': 1365619235, u'_segment:9334:cache': 0, u'_delivered_email:8857927': 1364327371, u'funnel_stage': u'Closed Lost', u'_segment:11802': 1367276159, u'created_at': 1362974400, u'contact_type': u'Student', u'_segment:12366': 1366304504, u'email': u'hobby.jayson@gmail.com', u'_first_seen': 1364312823, u'_delivered_email:10545933': 1366303666, u'unsubscribed': True, u'_segment:9308': 1363579200, u'_delivered_email:9495111': 1365003877, u'_opened_email:10545933': 1366304495, u'id': u'hobby.jayson@gmail.com', u'_opened_email:8857927': 1364327535, u'_delivered_email:9917528': 1365617214}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367276159, u'Unsubscribed': 1366304504, u'At least a week old': 1363579200, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': None, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'hobby.jayson@gmail.com'}, {u'attributes': {u'_last_emailed': 1365617212, u'_opened_email:8857931': 1364337123, u'_segment:11802': 1367336592, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'created_at': 1364184000, u'_trigger:7758': 1364313650, u'_segment:12366': 1365704380, u'email': u'joe@clikt.com', u'_first_seen': 1364313645, u'contact_type': u'Student', u'_delivered_email:9495118': 1365003876, u'_delivered_email:9917530': 1365617212, u'unsubscribed': True, u'_segment:9308': 1364788800, u'_trigger:5855': 1364313650, u'_delivered_email:8857931': 1364327369, u'_segment:8265': 1364313650, u'id': u'joe@clikt.com', u'_opened_email:9917530': 1365622820}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336592, u'Unsubscribed': 1365704380, u'At least a week old': 1364788800, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313650, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'joe@clikt.com'}, {u'attributes': {u'_last_emailed': 1365617218, u'_opened_email:9917617': 1365621723, u'_segment:11802': 1367336601, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'created_at': 1362546000, u'_delivered_email:9495194': 1365003882, u'_delivered_email:8858016': 1364327392, u'email': u'sumek@o2.pl', u'_first_seen': 1364313655, u'_segment:12366': 1365617340, u'_trigger:7758': 1364313664, u'unsubscribed': True, u'_segment:9308': 1364702400, u'_trigger:5855': 1364313664, u'_segment:8265': 1364313664, u'id': u'sumek@o2.pl', u'_delivered_email:9917617': 1365617218, u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336601, u'Unsubscribed': 1365617340, u'At least a week old': 1364702400, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313664, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'sumek@o2.pl'}, {u'attributes': {u'_delivered_email:10546031': 1366303672, u'_trigger:7758': 1364313672, u'id': u'tal@talsafran.com', u'_segment:9334:cache': 0, u'_delivered_email:11314677': 1366991336, u'_last_emailed': 1366991336, u'_opened_email:11314677': 1366992993, u'unsubscribed': True, u'_trigger:5855': 1364313672, u'email': u'tal@talsafran.com', u'_opened_email:9917633': 1365622108, u'_segment:11802': 1367336603, u'funnel_stage': u'Signed up', u'_delivered_email:9495208': 1365003881, u'_first_seen': 1364313661, u'_segment:9308': 1364702400, u'_delivered_email:9917633': 1365617221, u'_delivered_email:8858038': 1364327407, u'contact_type': u'Student', u'created_at': 1363579200, u'_segment:12366': 1366993014, u'_segment:8265': 1364313672}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336603, u'Unsubscribed': 1366993014, u'At least a week old': 1364702400, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313672, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'tal@talsafran.com'}, {u'attributes': {u'_opened_email:11314731': 1367078933, u'_opened_email:8858098': 1364746190, u'_delivered_email:9917687': 1365617221, u'_trigger:7758': 1364313676, u'id': u'bkclerke@gmail.com', u'_delivered_email:11314731': 1366991338, u'_segment:9334:cache': 0, u'_last_emailed': 1366991338, u'unsubscribed': True, u'_opened_email:9917687': 1365861131, u'_opened_email:10546126': 1366317424, u'email': u'bkclerke@gmail.com', u'_segment:11802': 1367336610, u'funnel_stage': u'Signed up', u'_delivered_email:10546126': 1366303678, u'_first_seen': 1364313668, u'_delivered_email:9495260': 1365003885, u'_trigger:5855': 1364313676, u'_segment:9308': 1364616000, u'contact_type': u'Student', u'_opened_email:9495260': 1365859973, u'created_at': 1361941200, u'_segment:12366': 1367078936, u'_delivered_email:8858098': 1364327412, u'_segment:8265': 1364313676}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336610, u'Unsubscribed': 1367078936, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313676, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'bkclerke@gmail.com'}, {u'attributes': {u'_last_emailed': 1365617224, u'_trigger:7758': 1364313679, u'_segment:11802': 1367336612, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'created_at': 1361854800, u'unsubscribed': True, u'_opened_email:9495276': 1365004585, u'_segment:12366': 1365618210, u'email': u'alberto@escarlate.com', u'_first_seen': 1364313670, u'contact_type': u'Student', u'_delivered_email:9495276': 1365003885, u'_delivered_email:8858129': 1364327420, u'_segment:9308': 1364616000, u'_trigger:5855': 1364313679, u'_opened_email:9917700': 1365623248, u'_segment:8265': 1364313679, u'id': u'alberto@escarlate.com', u'_delivered_email:9917700': 1365617224}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336612, u'Unsubscribed': 1365618210, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313679, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'alberto@escarlate.com'}, {u'attributes': {u'_opened_email:8858119': 1364332192, u'_delivered_email:10546095': 1366303677, u'_trigger:7758': 1364313683, u'id': u'ca@edmeme.com', u'_segment:9334:cache': 0, u'_last_emailed': 1366991339, u'_opened_email:11314756': 1366991832, u'unsubscribed': True, u'_delivered_email:9917706': 1365617223, u'_delivered_email:8858119': 1364327432, u'email': u'ca@edmeme.com', u'_delivered_email:9495296': 1365003887, u'_segment:11802': 1367336612, u'funnel_stage': u'Signed up', u'_first_seen': 1364313670, u'_trigger:5855': 1364313683, u'_delivered_email:11314756': 1366991339, u'_segment:9308': 1364616000, u'contact_type': u'Student', u'created_at': 1361854800, u'_segment:12366': 1366997534, u'_segment:8265': 1364313683}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336612, u'Unsubscribed': 1366997534, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313683, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'ca@edmeme.com'}, {u'attributes': {u'_delivered_email:9495311': 1365003885, u'_trigger:7758': 1364313684, u'id': u'randel24@gmail.com', u'_segment:9334:cache': 0, u'_opened_email:9495311': 1365006811, u'_last_emailed': 1366991338, u'unsubscribed': True, u'_trigger:5855': 1364313684, u'_delivered_email:9917704': 1365617223, u'_opened_email:11314759': 1367290797, u'email': u'randel24@gmail.com', u'_segment:11802': 1367336613, u'funnel_stage': u'Signed up', u'_delivered_email:10546108': 1366303675, u'_opened_email:10546108': 1366313372, u'_first_seen': 1364313672, u'_opened_email:8858120': 1364330181, u'_delivered_email:11314759': 1366991338, u'_segment:9308': 1364616000, u'contact_type': u'Student', u'_segment:8265': 1364313684, u'created_at': 1362546000, u'_segment:12366': 1367378962, u'_opened_email:9917704': 1365621845, u'_delivered_email:8858120': 1364327416}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336613, u'Unsubscribed': 1367378962, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313684, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'randel24@gmail.com'}, {u'attributes': {u'_last_emailed': 1366991340, u'_trigger:7758': 1364313683, u'unsubscribed': True, u'contact_type': u'Student', u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'_segment:11802': 1367336615, u'created_at': 1361941200, u'_delivered_email:10546114': 1366303677, u'_segment:12366': 1367013748, u'email': u'alan@fluentu.com', u'_first_seen': 1364313673, u'_delivered_email:8858132': 1364327417, u'_delivered_email:11314776': 1366991340, u'_delivered_email:9917724': 1365617228, u'_segment:9308': 1364616000, u'_trigger:5855': 1364313683, u'_opened_email:11314776': 1367013743, u'_segment:8265': 1364313683, u'id': u'alan@fluentu.com', u'_delivered_email:9495284': 1365003887}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336615, u'Unsubscribed': 1367013748, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313683, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'alan@fluentu.com'}, {u'attributes': {u'_last_emailed': 1365003891, u'_opened_email:9495408': 1365006409, u'_segment:11802': 1367336632, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'created_at': 1361941200, u'_trigger:7758': 1364313708, u'_segment:12366': 1365006414, u'email': u'slevinforbes@gmail.com', u'_first_seen': 1364313694, u'_delivered_email:9495408': 1365003891, u'unsubscribed': True, u'_delivered_email:8858243': 1364327496, u'_segment:9308': 1364616000, u'_trigger:5855': 1364313708, u'_segment:8265': 1364313708, u'id': u'slevinforbes@gmail.com', u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336632, u'Unsubscribed': 1365006414, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313708, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'slevinforbes@gmail.com'}, {u'attributes': {u'_last_emailed': 1365003892, u'_segment:11802': 1367336632, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'created_at': 1360040400, u'_trigger:7758': 1364313713, u'_segment:12366': 1365004154, u'email': u'list@rascoff.com', u'_first_seen': 1364313697, u'_delivered_email:8858283': 1364327515, u'_opened_email:9495427': 1365004024, u'unsubscribed': True, u'_segment:9308': 1364616000, u'_delivered_email:9495427': 1365003892, u'_trigger:5855': 1364313713, u'_segment:8265': 1364313713, u'id': u'list@rascoff.com', u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336632, u'Unsubscribed': 1365004154, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313713, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'list@rascoff.com'}, {u'attributes': {u'_delivered_email:9495470': 1365003891, u'_last_emailed': 1365003891, u'_opened_email:9495470': 1365045645, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'_segment:11802': 1367336635, u'_delivered_email:8858340': 1364327519, u'created_at': 1361854800, u'_trigger:7758': 1364313716, u'_segment:12366': 1365045714, u'email': u'jordankotto@gmail.com', u'_first_seen': 1364313700, u'unsubscribed': True, u'_segment:9308': 1364616000, u'_trigger:5855': 1364313716, u'_segment:8265': 1364313716, u'id': u'jordankotto@gmail.com', u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336635, u'Unsubscribed': 1365045714, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313716, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'jordankotto@gmail.com'}, {u'attributes': {u'_delivered_email:10546314': 1366303699, u'_trigger:7758': 1364313731, u'id': u'reyno310@msu.edu', u'_segment:9334:cache': 0, u'_last_emailed': 1366991365, u'unsubscribed': True, u'_trigger:5855': 1364313731, u'email': u'reyno310@msu.edu', u'_delivered_email:9917937': 1365617249, u'_segment:11802': 1367336645, u'funnel_stage': u'Signed up', u'_delivered_email:9495522': 1365003901, u'_opened_email:9495522': 1365006467, u'_opened_email:8858455': 1364327616, u'_segment:9308': 1364616000, u'_first_seen': 1364313710, u'_delivered_email:11314971': 1366991365, u'contact_type': u'Student', u'created_at': 1359522000, u'_segment:12366': 1367014148, u'_opened_email:9917937': 1365630235, u'_opened_email:10546314': 1366303771, u'_delivered_email:8858455': 1364327536, u'_opened_email:11314971': 1367014140, u'_segment:8265': 1364313731}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336645, u'Unsubscribed': 1367014148, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313731, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'reyno310@msu.edu'}, {u'attributes': {u'_last_emailed': 1365617237, u'_trigger:7758': 1364313731, u'_segment:11802': 1367336645, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'created_at': 1359435600, u'_delivered_email:9495532': 1365003898, u'_opened_email:9917923': 1365622432, u'_segment:12366': 1365617270, u'email': u'adam.l.stempel@gmail.com', u'_first_seen': 1364313710, u'unsubscribed': True, u'_segment:9308': 1364616000, u'_delivered_email:9917923': 1365617237, u'_trigger:5855': 1364313731, u'_delivered_email:8858400': 1364327524, u'_segment:8265': 1364313731, u'id': u'adam.l.stempel@gmail.com', u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336645, u'Unsubscribed': 1365617270, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313731, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'adam.l.stempel@gmail.com'}, {u'attributes': {u'_last_emailed': 1365617241, u'_delivered_email:8858430': 1364327534, u'_opened_email:9917925': 1365623084, u'_segment:9334:cache': 0, u'_opened_email:8858430': 1364331686, u'funnel_stage': u'Signed up', u'_segment:11802': 1367336643, u'created_at': 1361854800, u'_trigger:7758': 1364313732, u'_segment:12366': 1365617331, u'email': u'chris.mcaloney@gmail.com', u'_first_seen': 1364313710, u'unsubscribed': True, u'_segment:9308': 1364616000, u'_trigger:5855': 1364313732, u'_delivered_email:9495535': 1365003896, u'_opened_email:9495535': 1365034178, u'_segment:8265': 1364313732, u'id': u'chris.mcaloney@gmail.com', u'_delivered_email:9917925': 1365617241, u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336643, u'Unsubscribed': 1365617331, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313732, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'chris.mcaloney@gmail.com'}, {u'attributes': {u'_last_emailed': 1366991366, u'_trigger:7758': 1364313731, u'_segment:11802': 1367336648, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'_delivered_email:9495500': 1365003897, u'created_at': 1362114000, u'_delivered_email:8858439': 1364327531, u'_delivered_email:11315007': 1366991366, u'_delivered_email:9917943': 1365617242, u'email': u'knandyal@styloot.com', u'_first_seen': 1364313713, u'_segment:12366': 1366991399, u'unsubscribed': True, u'_segment:9308': 1364616000, u'_trigger:5855': 1364313731, u'_opened_email:11315007': 1366991395, u'_segment:8265': 1364313731, u'id': u'knandyal@styloot.com', u'_delivered_email:10546329': 1366303693, u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336648, u'Unsubscribed': 1366991399, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313731, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'knandyal@styloot.com'}, {u'attributes': {u'_delivered_email:8858432': 1364327539, u'_last_emailed': 1365617242, u'_opened_email:8858432': 1364348780, u'_segment:11802': 1367336648, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'_delivered_email:9917934': 1365617242, u'created_at': 1362027600, u'_trigger:7758': 1364313730, u'_opened_email:9917934': 1365620105, u'_segment:12366': 1365617606, u'email': u'thinkful@jandgnoel.com', u'_first_seen': 1364313712, u'unsubscribed': True, u'_opened_email:9495506': 1365015081, u'_segment:9308': 1364616000, u'_trigger:5855': 1364313730, u'_delivered_email:9495506': 1365003897, u'_segment:8265': 1364313730, u'id': u'thinkful@jandgnoel.com', u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336648, u'Unsubscribed': 1365617606, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313730, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'thinkful@jandgnoel.com'}, {u'attributes': {u'_last_emailed': 1365024771, u'_opened_email:9495507': 1365033703, u'_segment:11802': 1367336648, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'created_at': 1361941200, u'_trigger:7758': 1364313731, u'_segment:12366': 1365121347, u'email': u'toccata996@yahoo.com', u'_first_seen': 1364313713, u'unsubscribed': True, u'_segment:9308': 1364616000, u'_delivered_email:8858458': 1364327535, u'_trigger:5855': 1364313731, u'_delivered_email:9495507': 1365024771, u'_segment:8265': 1364313731, u'id': u'toccata996@yahoo.com', u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336648, u'Unsubscribed': 1365121347, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313731, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'toccata996@yahoo.com'}, {u'attributes': {u'_delivered_email:8858519': 1364327543, u'_last_emailed': 1365003899, u'_segment:11802': 1367336650, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'_opened_email:9495566': 1365012779, u'created_at': 1423890000, u'contact_type': u'Student', u'_segment:12366': 1365012776, u'email': u'nc11sahe@stud.rcnuwc.no', u'_first_seen': 1364313717, u'_delivered_email:9495566': 1365003899, u'unsubscribed': True, u'_trigger:7758': 1364313742, u'_trigger:5855': 1364313742, u'_segment:8265': 1364313742, u'id': u'nc11sahe@stud.rcnuwc.no'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336650, u'Unsubscribed': 1365012776, u'At least a week old': None, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313742, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'nc11sahe@stud.rcnuwc.no'}, {u'attributes': {u'_last_emailed': 1365003900, u'_delivered_email:9495606': 1365003900, u'_segment:11802': 1367336658, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'created_at': 1361854800, u'_trigger:7758': 1364313745, u'_delivered_email:8858562': 1364327545, u'email': u'charles@charlesism.com', u'_first_seen': 1364313723, u'_segment:12366': 1365015343, u'_opened_email:9495606': 1365015336, u'unsubscribed': True, u'_segment:9308': 1364616000, u'_trigger:5855': 1364313745, u'_segment:8265': 1364313745, u'id': u'charles@charlesism.com', u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336658, u'Unsubscribed': 1365015343, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313745, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'charles@charlesism.com'}, {u'attributes': {u'_delivered_email:9495614': 1365003902, u'_last_emailed': 1365617250, u'_opened_email:9495614': 1365004135, u'_segment:11802': 1367336658, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'created_at': 1361854800, u'_trigger:7758': 1364313749, u'_segment:12366': 1365617829, u'email': u'jckime@gmail.com', u'_first_seen': 1364313724, u'contact_type': u'Student', u'_opened_email:9918038': 1365623307, u'_delivered_email:8858609': 1364327554, u'unsubscribed': True, u'_segment:9308': 1364616000, u'_opened_email:8858609': 1364327579, u'_trigger:5855': 1364313749, u'_segment:8265': 1364313749, u'id': u'jckime@gmail.com', u'_delivered_email:9918038': 1365617250}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336658, u'Unsubscribed': 1365617829, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313749, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'jckime@gmail.com'}, {u'attributes': {u'_last_emailed': 1365003903, u'_segment:11802': 1367336664, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'created_at': 1361941200, u'_trigger:7758': 1364313752, u'_delivered_email:9495638': 1365003903, u'_segment:12366': 1365003943, u'email': u'russellcox@gmail.com', u'_first_seen': 1364313728, u'_opened_email:9495638': 1365003938, u'unsubscribed': True, u'_delivered_email:8858604': 1364327549, u'_trigger:5855': 1364313752, u'_segment:8265': 1364313752, u'id': u'russellcox@gmail.com', u'_segment:9308': 1364616000, u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336664, u'Unsubscribed': 1365003943, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313752, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'russellcox@gmail.com'}, {u'attributes': {u'_last_emailed': 1366303699, u'_delivered_email:9918076': 1365617254, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'_segment:11802': 1367336664, u'_opened_email:10546466': 1366304965, u'created_at': 1361941200, u'_trigger:7758': 1364313755, u'_segment:12366': 1366304982, u'email': u'bering@gmail.com', u'_first_seen': 1364313728, u'_delivered_email:10546466': 1366303699, u'_delivered_email:9495641': 1365003905, u'unsubscribed': True, u'_segment:9308': 1364616000, u'_delivered_email:8858605': 1364327548, u'_trigger:5855': 1364313755, u'_segment:8265': 1364313755, u'id': u'bering@gmail.com', u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336664, u'Unsubscribed': 1366304982, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313755, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'bering@gmail.com'}, {u'attributes': {u'_last_emailed': 1365003906, u'_delivered_email:9495712': 1365003906, u'_segment:11802': 1367336672, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'created_at': 1359954000, u'_trigger:7758': 1364313770, u'_delivered_email:8858688': 1364327570, u'_segment:12366': 1365012380, u'email': u'anand.jeyahar@gmail.com', u'_first_seen': 1364313740, u'unsubscribed': True, u'_segment:9308': 1364616000, u'_trigger:5855': 1364313770, u'_opened_email:9495712': 1365012670, u'_segment:8265': 1364313770, u'id': u'anand.jeyahar@gmail.com', u'contact_type': u'Student'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336672, u'Unsubscribed': 1365012380, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313770, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'anand.jeyahar@gmail.com'}, {u'attributes': {u'_delivered_email:9495761': 1365003906, u'_trigger:7758': 1364313776, u'id': u'nathanaelosbert@outlook.com', u'_segment:9334:cache': 0, u'_last_emailed': 1366303708, u'_delivered_email:8858728': 1364327606, u'unsubscribed': True, u'_opened_email:9495761': 1366810428, u'email': u'nathanaelosbert@outlook.com', u'_segment:11802': 1367336680, u'funnel_stage': u'Signed up', u'_first_seen': 1364313744, u'_delivered_email:9918178': 1365617257, u'_delivered_email:10546589': 1366303708, u'_trigger:5855': 1364313776, u'_segment:9308': 1364616000, u'_opened_email:8858728': 1366810579, u'_opened_email:10546589': 1366810266, u'_opened_email:9918178': 1366810399, u'contact_type': u'Student', u'created_at': 1361941200, u'_segment:12366': 1366810323, u'_segment:8265': 1364313776}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336680, u'Unsubscribed': 1366810323, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313776, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'nathanaelosbert@outlook.com'}, {u'attributes': {u'_delivered_email:9918211': 1365617278, u'_opened_email:11315250': 1366992100, u'_opened_email:8858753': 1364385580, u'_trigger:7758': 1364313779, u'id': u'rsprosty10@yahoo.com', u'_segment:9334:cache': 0, u'_delivered_email:9495770': 1365033708, u'_last_emailed': 1366991387, u'unsubscribed': True, u'_trigger:5855': 1364313779, u'email': u'rsprosty10@yahoo.com', u'_segment:11802': 1367336682, u'funnel_stage': u'Signed up', u'_first_seen': 1364313746, u'_delivered_email:11315250': 1366991387, u'_opened_email:10546618': 1366303961, u'_delivered_email:10546618': 1366303712, u'_segment:9308': 1364616000, u'contact_type': u'Student', u'_delivered_email:8858753': 1364327596, u'created_at': 1361854800, u'_segment:12366': 1366992116, u'_opened_email:9918211': 1365628639, u'_segment:8265': 1364313779, u'_opened_email:9495770': 1365040636}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336682, u'Unsubscribed': 1366992116, u'At least a week old': 1364616000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313779, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'rsprosty10@yahoo.com'}, {u'attributes': {u'_last_emailed': 1366303707, u'_delivered_email:9495774': 1365003909, u'_segment:11802': 1367336732, u'_segment:9334:cache': 0, u'funnel_stage': u'Signed up', u'_delivered_email:10546604': 1366303707, u'created_at': 1363924800, u'_trigger:7758': 1364313778, u'_segment:12366': 1366304438, u'email': u'rhone.j@gmail.com', u'_first_seen': 1364313747, u'_delivered_email:9918196': 1365617261, u'contact_type': u'Student', u'unsubscribed': True, u'_segment:9308': 1364529600, u'_trigger:5855': 1364313778, u'_delivered_email:8858736': 1364327593, u'_segment:8265': 1364313778, u'id': u'rhone.j@gmail.com', u'_opened_email:10546604': 1366304437}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336732, u'Unsubscribed': 1366304438, u'At least a week old': 1364529600, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1364313778, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'rhone.j@gmail.com'}, {u'attributes': {u'_last_emailed': 1367425258, u'_opened_email:11636467': 1367429646, u'_segment:11802': 1367336580, u'funnel_stage': u'Signed up', u'created_at': 1349064000, u'contact_type': u'Student', u'_segment:12366': 1367932382, u'email': u'joanne_hwang1223@hotmail.com', u'_first_seen': 1367035136, u'unsubscribed': True, u'_trigger:7758': 1367035137, u'_segment:9308': 1365393600, u'_segment:8265': 1367035137, u'id': u'joanne_hwang1223@hotmail.com', u'_delivered_email:11636467': 1367425258}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367336580, u'Unsubscribed': 1367932382, u'At least a week old': 1365393600, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1367035137, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'joanne_hwang1223@hotmail.com'}, {u'attributes': {u'_last_emailed': 1367425280, u'_segment:11802': 1367276223, u'contact_type': u'Student', u'_delivered_email:11636722': 1367425280, u'created_at': 1361941200, u'funnel_stage': u'Closed Lost', u'_segment:12366': 1367932594, u'email': u'aaron.j.flack@gmail.com', u'_first_seen': 1367276223, u'unsubscribed': True, u'_segment:9308': 1362546000, u'id': u'aaron.j.flack@gmail.com'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367276223, u'Unsubscribed': 1367932594, u'At least a week old': 1362546000, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': None, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'aaron.j.flack@gmail.com'}, {u'attributes': {u'_last_emailed': 1367425282, u'_segment:11802': 1367276233, u'contact_type': u'Student', u'created_at': 1360472400, u'funnel_stage': u'Closed Lost', u'_delivered_email:11636780': 1367425282, u'email': u'zamyz11@gmail.com', u'_first_seen': 1367276233, u'_segment:12366': 1367932610, u'_opened_email:11636780': 1367504239, u'_segment:9308': 1361077200, u'id': u'zamyz11@gmail.com', u'unsubscribed': True}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367276233, u'Unsubscribed': 1367932610, u'At least a week old': 1361077200, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': None, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'zamyz11@gmail.com'}, {u'attributes': {u'_last_emailed': 1367425284, u'unsubscribed': True, u'_segment:11802': 1367276243, u'contact_type': u'Student', u'created_at': 1361854800, u'funnel_stage': u'Expressed interest', u'_segment:12366': 1367932629, u'email': u'pruchniewski.matt@gmail.com', u'_first_seen': 1367276243, u'_segment:8885': 1367276244, u'_delivered_email:11636788': 1367425284, u'_segment:9308': 1362459600, u'id': u'pruchniewski.matt@gmail.com', u'_opened_email:11636788': 1367425339}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367276243, u'Unsubscribed': 1367932629, u'At least a week old': 1362459600, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': 1367276244, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': None, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'pruchniewski.matt@gmail.com'}, {u'attributes': {u'_last_emailed': 1367425285, u'_delivered_email:11636815': 1367425285, u'_segment:11802': 1367276248, u'contact_type': u'Student', u'created_at': 1362718800, u'funnel_stage': u'Withdrew from course', u'_segment:12366': 1367932648, u'email': u'breeden.matt@gmail.com', u'_first_seen': 1367276245, u'unsubscribed': True, u'_segment:9308': 1363323600, u'_opened_email:11636815': 1367425950, u'id': u'breeden.matt@gmail.com'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367276248, u'Unsubscribed': 1367932648, u'At least a week old': 1363323600, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': None, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'breeden.matt@gmail.com'}, {u'attributes': {u'_last_emailed': 1367931858, u'_opened_email:11636831': 1367436163, u'_delivered_email:12252976': 1367931858, u'_delivered_email:11636831': 1367425289, u'_segment:11802': 1367285342, u'funnel_stage': u'Signed up', u'created_at': 1367294400, u'contact_type': u'Student', u'_segment:12366': 1368036549, u'id': u'gregoriourena@outlook.com', u'_first_seen': 1367285341, u'_delivered_email:11532360': 1367336392, u'_delivered_email:11532361': 1367336393, u'unsubscribed': True, u'_segment:9308': 1367899200, u'_trigger:7758': 1367285343, u'_segment:8265': 1367285343, u'email': u'gregoriourena@outlook.com'}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367285342, u'Unsubscribed': 1368036549, u'At least a week old': 1367899200, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': None, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': 1367285343, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'gregoriourena@outlook.com'}, {u'attributes': {u'_last_emailed': 1367425287, u'_opened_email:11636858': 1367433909, u'_segment:11802': 1367375388, u'contact_type': u'Student', u'created_at': 1366516800, u'funnel_stage': u'Expressed interest', u'_segment:12366': 1367932510, u'email': u'rickymram@hotmail.com', u'_first_seen': 1367375387, u'_segment:8885': 1367375389, u'_delivered_email:11636858': 1367425287, u'_segment:9308': 1367121600, u'id': u'rickymram@hotmail.com', u'unsubscribed': True}, u'segments': {u'funnel_stage - On fence / Wants to think it over': None, u'contact_type - Student': 1367375388, u'Unsubscribed': 1367932510, u'At least a week old': 1367121600, u'Mentors': None, u'funnel_stage - Call confirmed': None, u'funnel_stage - Expressed interest': 1367375389, u'funnel_stage - Verbal close': None, u'funnel_stage - Signed up': None, u'Missing funnel_stage': None, u'Email bounce': None, u'Thinks': None, u'Missing contact_type': None}, u'id': u'rickymram@hotmail.com'}], u'total': 39}
    for customer in segment_json['customers']:
        tfp = ThinkfulPerson.from_cio(customer)
        unsubscribed.add(tfp)
    print "Found %s unsubscribed customers." % len(unsubscribed)
    return unsubscribed

def _update_zoho_unsubscriber(crm, tfp):
    if tfp.is_lead:
        search_f, update_f, key = crm.search_leads, crm.update_leads, "LEADID"
    else:
        search_f, update_f, key = crm.search_contacts, crm.update_contacts, "CONTACTID"

    members = search_f("(Email|=|%s)" % tfp.email)
    if not members:
        raise Exception(
            "***ERROR*** Could not find %s using %s!" % (tfp, search_f))
    if len(members) > 1:
        raise Exception(
            "***ERROR*** More than one person found for %s using %s!" % (tfp, search_f))
    update_f([{
        "Id" : members[0][key],
        "Email Opt Out": "true",
    }])
    return True

def mismatched_unsubscribed(crm, cio):
    unsub_zoho = _get_zoho_unsubscribed(crm)
    unsub_cio = _get_cio_unsubscribed(cio)

    # Unsubscribed in Zoho not synced to CIO
    print "Found %s email(s) in Zoho not in CIO." % len(unsub_zoho - unsub_cio)
    for tfp in unsub_zoho - unsub_cio:
        print "  In Zoho not in CIO:", tfp
        cio.identify(id=tfp.email, unsubscribed=True)

    # Unsubscribed in CIO not synced to Zoho
    print "Found %s email(s) in CustomerIO not in Zoho." % len(unsub_cio - unsub_zoho)
    for tfp in unsub_cio - unsub_zoho:
        print "  In CIO not in Zoho:",  tfp
        _update_zoho_unsubscriber(crm, tfp)

def main():
    parser = OptionParser("%prog --rpt_bad_data | --send_potentials_to_cio | --send_leads_to_cio")
    parser.add_option("--rpt_bad_data", action="store_true"
        , help="Report bad data in CRM (this is read-only)")
    parser.add_option("--send_potentials_to_cio", action="store_true"
        , help="Send all 'potentials' from Zoho to customer.io")
    parser.add_option("--send_leads_to_cio", action="store_true"
        , help="Send all 'leads' from Zoho to customer.io")
    parser.add_option("--use_api_allowance", action="store_true"
        , help="use valuable API allowances instead of cached copy. Beware api limits in Zoho!")
    (options, args) = parser.parse_args()

    (options, args) = parser.parse_args()
    # note Zoho requires your password... Did these as env vars so at least 
    # they wouldn't be recorded in your .bash_history
    crm = get_crm()
    crm.open()
    crm.use_api_allowance = options.use_api_allowance

    if options.send_potentials_to_cio or options.send_leads_to_cio or options.rpt_bad_data:
        cio = get_cio()

    if options.rpt_bad_data:
        # all_leads_also_contacts(crm)
        # mismatched_signup_date_potentials_contacts(crm)
        # missing_signup_date_leads(crm)
        mismatched_unsubscribed(crm, cio)
    if options.send_potentials_to_cio:
        send_potentials_to_customerio(crm, cio)
    if options.send_leads_to_cio:
        send_leads_to_customerio(crm, cio)

if __name__ == '__main__':
    main()

